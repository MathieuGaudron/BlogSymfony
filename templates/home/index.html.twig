{% extends 'base.html.twig' %}

{% block title %}Accueil{% endblock %}

{% block body %}
<div class="auth-bg">
  <div class="admin-wrap home-wrap">

    <div class="home-head">
      <h1 class="admin-title home-title">Posts</h1>

      <div class="home-tools">
        <form class="home-filter" method="get" action="{{ path('app_home') }}">
          <select class="admin-control home-select" name="category" onchange="this.form.submit()">
            <option value="">Toutes les catégories</option>

            {% for cat in categories %}
              <option value="{{ cat.id }}" {{ selectedCategory == cat.id ? 'selected' : '' }}>
                {{ cat.name }}
              </option>
            {% endfor %}
          </select>

          <noscript>
            <button class="btn-auth home-add" type="submit">Filtrer</button>
          </noscript>
        </form>

        {% if is_granted('ROLE_USER') %}
          <a class="btn-auth home-add home-add--small" href="{{ path('posts_new') }}">+ Post</a>
        {% endif %}
      </div>
    </div>

    <div class="posts-grid">
      {% for post in posts %}
        <article class="post-card">
          <div class="post-head">
            <h2 class="post-title">
              <a class="admin-link" href="{{ path('posts_show', { id: post.id }) }}">
                {{ post.title }}
              </a>
            </h2>
            <div class="post-meta">
              <span>{{ post.publishedAt|date('d/m/Y H:i') }}</span>
              <span>•</span>
              <span>{{ post.author.firstName ?? 'Auteur' }}</span>
              <span>•</span>
              <span>{{ post.category.name ?? 'Catégorie' }}</span>
            </div>
          </div>

          {% if post.picture %}
            <img class="post-img" src="{{ asset('uploads/posts/' ~ post.picture) }}" alt="">
          {% endif %}

          <p class="post-content">{{ post.content }}</p>

          <div class="comments">
            <h3 class="comments-title">Commentaires</h3>

            {% for comment in post.comments %}
              <div class="comment">
                <div class="comment-meta">
                  <strong>{{ comment.author.firstName ?? 'Anonyme' }}</strong>
                  <span>•</span>
                  <span>{{ comment.createdAt|date('d/m/Y H:i') }}</span>
                </div>
                <div class="comment-text">{{ comment.content }}</div>
              </div>
            {% else %}
              <p class="admin-empty">Aucun commentaire.</p>
            {% endfor %}

            {% if app.user %}
              <form class="comment-form" method="post" action="{{ path('post_add_comment', {id: post.id}) }}">
                <input type="hidden" name="_token" value="{{ csrf_token('add_comment_' ~ post.id) }}">

                <textarea class="admin-control admin-control--textarea comment-textarea"
                          name="content"
                          placeholder="Écris un commentaire..."
                          required></textarea>

                <div class="comment-actions">
                  <button class="btn-auth admin-submit" type="submit">Commenter</button>
                </div>
              </form>
            {% else %}
              <p class="admin-empty">
                <a class="admin-link" href="{{ path('app_login') }}">Connecte-toi</a> pour commenter.
              </p>
            {% endif %}
          </div>
        </article>
      {% else %}
        <p class="admin-empty">Aucun post pour l’instant.</p>
      {% endfor %}
    </div>

  </div>
</div>
{% endblock %}